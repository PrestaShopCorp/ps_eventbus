name: 🧪 EVENTBUS E2E TESTS

on:
  workflow_dispatch:
    inputs:
      incremental:
        type: boolean
        description: Run incremental-sync campaign
        required: false
        default: true
      full:
        type: boolean
        description: Run full-sync campaign
        required: false
        default: false
      ps_latest:
        type: boolean
        description: Latest available flashlight
        required: false
        default: true
      ps_8_1_7:
        type: boolean
        description: Flashlight 8.1.7-nginx
        required: false
        default: true
      ps_8_0_5:
        type: boolean
        description: Flashlight 8.0.5-nginx
        required: false
        default: true
      ps_1_7_8_11:
        type: boolean
        description: Flashlight 1.7.8.11-nginx
        required: false
        default: true
      ps_1_7_7_8:
        type: boolean
        description: Flashlight 1.7.7.8-nginx
        required: false
        default: true
      ps_1_6_1_11:
        type: boolean
        description: Flashlight 1.6.1.11-nginx
        required: false
        default: true

env:
  SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
  NODE_BUILDER_VERSION: "20"

jobs:
  generate-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: 🧮 Generate matrix JSON
        id: set-matrix
        run: |
          echo "📦 Building matrix…"

          campaigns=()
          [[ "${{ inputs.incremental }}" == "true" ]] && campaigns+=("incremental")
          [[ "${{ inputs.full }}" == "true" ]] && campaigns+=("full")

          versions=()
          [[ "${{ inputs.ps_latest }}" == "true" ]] && versions+=("latest")
          [[ "${{ inputs.ps_8_1_7 }}" == "true" ]] && versions+=("8.1.7-nginx")
          [[ "${{ inputs.ps_8_0_5 }}" == "true" ]] && versions+=("8.0.5-nginx")
          [[ "${{ inputs.ps_1_7_8_11 }}" == "true" ]] && versions+=("1.7.8.11-nginx")
          [[ "${{ inputs.ps_1_7_7_8 }}" == "true" ]] && versions+=("1.7.7.8-nginx")
          [[ "${{ inputs.ps_1_6_1_11 }}" == "true" ]] && versions+=("1.6.1.11-nginx")

          # fallback si vide → on prend tout
          [[ "${#campaigns[@]}" -eq 0 ]] && campaigns=("incremental" "full")
          [[ "${#versions[@]}" -eq 0 ]] && versions=("latest" "8.1.7-nginx" "8.0.5-nginx" "1.7.8.11-nginx" "1.7.7.8-nginx" "1.6.1.11-nginx")

          # build matrix
          matrix="["
          for c in "${campaigns[@]}"; do
            for v in "${versions[@]}"; do
              matrix+='{"campaign":"'"$c"'","ps_version":"'"$v"'"},'
            done
          done
          matrix="${matrix%,}"  # remove last comma
          matrix+="]"

          echo "Generated matrix:"
          echo "$matrix"

          echo "matrix=$matrix" >> $GITHUB_OUTPUT

  e2e_tests:
    name: 🚀 Run matrix
    needs: generate-matrix
    runs-on: ubuntu-latest
    strategy:
      max-parallel: 3
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.generate-matrix.outputs.matrix) }}

    env:
      CAMPAIGN: ${{ matrix.campaign }}
      DOCKER_IMAGE_PRESTASHOP: prestashop/prestashop-flashlight:${{ matrix.ps_version }}
      HOST_PORT_BIND_PRESTASHOP: 8000
      HOST_PORT_BIND_MYSQL: 3306
      HOST_PORT_BIND_PHP_MY_ADMIN: 6060
      HOST_PORT_BIND_CLOUDSYNC_REVERSE_PROXY: 3030
      SYNC_API_PORT: 3232
      COLLECTOR_API_PORT: 3333
      LIVE_SYNC_API_PORT: 3434
      WS_PORT: 8080

    steps:
      - name: 🛎️ Checkout the repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: 📦 Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: 🧰 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_BUILDER_VERSION }}
          cache: "pnpm"
          cache-dependency-path: e2e/V2/pnpm-lock.yaml

      - name: 📁 Cache vendor folder
        uses: actions/cache@v4
        with:
          path: vendor
          key: php-${{ hashFiles('composer.lock') }}

      - name: 🎼 Install PHP dependencies
        run: composer install

      - name: 🧪 Setup e2e-env with Prestashop ${{ matrix.ps_version }}
        run: |
          cp .env.dist .env
          docker compose build
          docker compose --profile cicd up --detach --wait
        env:
          DOCKER_IMAGE_PRESTASHOP: prestashop/prestashop-flashlight:${{matrix.ps_version}}
        working-directory: ./e2e-env

      - name: 👨🏻‍💻 Install tests dependencies
        run: pnpm install
        working-directory: ./e2e

      - name: 👨🏻‍💻 Install tests V2 dependencies
        run: pnpm install
        working-directory: ./e2e/V2

      - name: 🎭 Install Playwright
        run: pnpm playwright install --with-deps
        working-directory: ./e2e/V2

      - name: 🧪 Run ${{ matrix.campaign }} tests
        run: pnpm run test:${{ matrix.campaign }}
        working-directory: ./e2e/V2

      - name: 📤 Upload Playwright Test Reports
        uses: actions/upload-artifact@v4
        if: ${{ always() }}
        with:
          name: ${{ env.PLAYWRIGHT_NAME }}
          path: ./e2e/V2/playwright-report
        env:
          PLAYWRIGHT_NAME: ${{ matrix.ps_version }}-${{ matrix.campaign }}-playwright-report

      - name: Send Slack notification 📬
        if: ${{ always() }}
        run: |
          echo "📤 Preparing Slack notification..."

          STATS_PATH="./e2e/V2/playwright-report/.playwright-status/stats.json"

          if [ -f "$STATS_PATH" ]; then
            passed=$(jq '.suites | map(.tests | map(select(.status == "passed")) | length) | add' "$STATS_PATH")
            failed=$(jq '.suites | map(.tests | map(select(.status == "failed")) | length) | add' "$STATS_PATH")
            total=$((passed + failed))
            campaign="${{ matrix.campaign }}"
            version="${{ matrix.ps_version }}"
            repo="${{ github.repository }}"
            run_url="https://github.com/${repo}/actions/runs/${{ github.run_id }}"

            message="🧪 *E2E Test Report*\n"
            message+="📦 *Campaign*: \`${campaign}\`\n"
            message+="🔢 *Version*: \`${version}\`\n"
            message+="✅ Passed: *${passed}* / ❌ Failed: *${failed}* / 🧮 Total: *${total}*\n"
            message+="🔗 <${run_url}|Voir les détails>"

            payload=$(jq -n --arg text "$message" '{text: $text}')
            curl -X POST -H 'Content-type: application/json' --data "$payload" "$SLACK_WEBHOOK_URL"
          else
            echo "⚠️ Fichier de stats non trouvé à $STATS_PATH"
          fi
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

